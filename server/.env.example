# ──────────────────────────────────────────────────────────────────────────────
# P2Picks Server — Environment Variables
# ──────────────────────────────────────────────────────────────────────────────
# Copy this file to .env and fill in real values.
#   cp .env.example .env
#
# All variables marked (required) MUST be set; the server will refuse to start
# without them. Optional variables show their default value.
#
# Validated at startup by Zod schema in src/config/env.ts.
# ──────────────────────────────────────────────────────────────────────────────

# ── Server ───────────────────────────────────────────────────────────────────

# The port Express will listen on.
# Type: integer  |  Default: 5001
PORT=5001

# Node.js runtime environment. Controls log level (debug in dev, info in prod),
# Zod validation strictness, and whether startup crashes on missing env vars.
# Allowed: development | production | test  |  Default: development
NODE_ENV=development

# Comma-separated list of allowed CORS origins. Use "*" to allow all origins
# (not recommended for production). If omitted, defaults to localhost:5173.
# Example: https://app.p2picks.com,https://staging.p2picks.com
CORS_ALLOWED_ORIGINS=http://localhost:5173

# ── Supabase (required) ─────────────────────────────────────────────────────

# Your Supabase project URL (e.g. https://xyzcompany.supabase.co).
# (required)
SUPABASE_URL=https://your-project.supabase.co

# The service-role key has FULL database access and bypasses all RLS policies.
# ⚠️  NEVER expose this in client-side code or public repos.
# Used by background services (lifecycle queue, resolution queue, data ingest).
# (required)
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# The anon (public) key is used to create per-request, user-scoped Supabase
# clients that respect RLS when acting on behalf of authenticated users.
# (required)
SUPABASE_ANON_KEY=your-anon-key-here

# ── Redis (required) ────────────────────────────────────────────────────────

# Full Redis connection URL. Used for caching, rate limiting, config sessions,
# and BullMQ job queues.
# Format: redis://[username]:[password]@host:port
# (required)
REDIS_URL=redis://default:yourpassword@your-redis-host:6379

# ── Resolution Queue ────────────────────────────────────────────────────────

# Whether to use the BullMQ resolution queue for bet resolution jobs.
# When disabled ("false"), resolution happens via direct DB calls.
# Type: boolean string ("true" / "false")  |  Default: true
USE_RESOLUTION_QUEUE=true

# Maximum parallel BullMQ resolution worker jobs.
# Higher values improve throughput but increase DB connection load.
# Type: integer (>0)  |  Default: 5
RESOLUTION_QUEUE_CONCURRENCY=5

# ── Bet Lifecycle ───────────────────────────────────────────────────────────

# Interval between catchup sweeps that find overdue active bets and transition
# them to pending. Acts as a safety net for missed BullMQ delayed jobs.
# Type: integer (ms, ≥30000)  |  Default: 60000 (1 minute)
BET_LIFECYCLE_CATCHUP_MS=60000

# ── NFL Data Ingest ─────────────────────────────────────────────────────────

# Test mode for NFL data ingestion. Controls data source:
#   off     → Live ESPN API polling (production mode)
#   raw     → Copy test_nfl_data/nfl_raw_live_stats → nfl_raw_live_stats, then refine
#   refined → Copy test_nfl_data/nfl_refined_live_stats directly (skip raw parsing)
# Default: off
NFL_DATA_TEST_MODE=off

# Base polling interval for the NFL ESPN API (seconds).
# The actual interval may be longer during failures (adaptive backoff: base × 2^failures, cap 16×).
# Type: integer (≥12)  |  Default: 20
NFL_DATA_INTERVAL_SECONDS=20

# Random jitter applied to the raw polling interval to avoid thundering herd.
# Expressed as a percentage of the base interval.
# Type: integer (≥5)  |  Default: 10
NFL_DATA_RAW_JITTER_PERCENT=10

# Minimum seconds between roster refreshes per team.
# Type: integer (≥1440 = 24h minimum)  |  Default: 86400 (24 hours)
NFL_ROSTER_REFRESH_SECONDS=86400

# Interval for polling NFL game status (game start/end detection).
# Type: integer (ms, ≥30000)  |  Default: 30000
NFL_GAME_STATUS_POLL_MS=30000

# ── NBA Data Ingest ─────────────────────────────────────────────────────────

# Test mode for NBA data ingestion. Same semantics as NFL_DATA_TEST_MODE:
#   off     → Live API polling
#   raw     → Use test fixtures (raw stage)
#   refined → Use test fixtures (refined stage)
# Default: off
NBA_DATA_TEST_MODE=off

# Base polling interval for the NBA API (seconds).
# Adaptive backoff applies on consecutive failures.
# Type: integer (≥12)  |  Default: 20
NBA_DATA_INTERVAL_SECONDS=20

# Random jitter applied to the raw polling interval.
# Type: integer (≥5)  |  Default: 10
NBA_DATA_RAW_JITTER_PERCENT=10
